# TechSpec: AI ë§ì”€ë¹„ì„œ
## ê¸°ìˆ  ì‚¬ì–‘ì„œ v1.0

---

## 1. ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ ê°œìš”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   í´ë¼ì´ì–¸íŠ¸ ë ˆì´ì–´                   â”‚
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Flutter App  â”‚          â”‚   Pastor Web App  â”‚    â”‚
â”‚  â”‚  (iOS/Android)â”‚          â”‚   (React/Next.js) â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚ HTTPS/WSS                 â”‚ HTTPS
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         â”‚      Firebase ë ˆì´ì–´       â”‚             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚              Firebase SDK               â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                     â”‚                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚           Firebase Services             â”‚      â”‚
â”‚  â”‚  Auth â”‚ Firestore â”‚ Storage â”‚ FCM â”‚ CF  â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”˜
                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”
â”‚                   AI ë ˆì´ì–´                         â”‚
â”‚                                                     â”‚
â”‚  Phase 1: Pastors.ai API                            â”‚
â”‚  Phase 2: OpenAI (Whisper + GPT-4)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”˜
```

---

## 2. í”„ë¡ íŠ¸ì—”ë“œ (Flutter)

### 2.1 í”„ë ˆì„ì›Œí¬ ë° ë²„ì „

```yaml
# pubspec.yaml
name: chimshin_bible_note
description: AI ë§ì”€ë¹„ì„œ - ì¹¨ì‹  ë§ì”€ë…¸íŠ¸

environment:
  sdk: '>=3.0.0 <4.0.0'
  flutter: '>=3.10.0'

dependencies:
  flutter:
    sdk: flutter

  # ìƒíƒœ ê´€ë¦¬
  flutter_riverpod: ^2.4.0
  riverpod_annotation: ^2.2.0

  # Firebase
  firebase_core: ^2.24.0
  firebase_auth: ^4.15.0
  cloud_firestore: ^4.13.0
  firebase_storage: ^11.5.0
  firebase_messaging: ^14.7.0
  firebase_analytics: ^10.7.0

  # ì†Œì…œ ë¡œê·¸ì¸
  google_sign_in: ^6.2.0
  kakao_flutter_sdk: ^1.7.0

  # UI
  go_router: ^12.1.0
  flutter_local_notifications: ^16.3.0
  cached_network_image: ^3.3.0
  shimmer: ^3.0.0

  # ì˜¤ë””ì˜¤
  just_audio: ^0.9.36
  audio_service: ^0.18.12

  # ìœ í‹¸ë¦¬í‹°
  intl: ^0.18.0
  shared_preferences: ^2.2.2
  connectivity_plus: ^5.0.2
  package_info_plus: ^5.0.1
  url_launcher: ^6.2.1

dev_dependencies:
  flutter_test:
    sdk: flutter
  riverpod_generator: ^2.3.0
  build_runner: ^2.4.6
  flutter_lints: ^3.0.0
  mockito: ^5.4.3
```

### 2.2 í”„ë¡œì íŠ¸ êµ¬ì¡°

```
lib/
â”œâ”€â”€ main.dart
â”œâ”€â”€ app.dart                    # MaterialApp + GoRouter ì„¤ì •
â”‚
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ constants/
â”‚   â”‚   â”œâ”€â”€ app_colors.dart     # ìƒ‰ìƒ ìƒìˆ˜
â”‚   â”‚   â”œâ”€â”€ app_strings.dart    # í…ìŠ¤íŠ¸ ìƒìˆ˜
â”‚   â”‚   â””â”€â”€ app_sizes.dart      # ì‚¬ì´ì¦ˆ ìƒìˆ˜
â”‚   â”‚
â”‚   â”œâ”€â”€ theme/
â”‚   â”‚   â”œâ”€â”€ app_theme.dart      # ì „ì²´ í…Œë§ˆ
â”‚   â”‚   â””â”€â”€ text_styles.dart    # í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼
â”‚   â”‚
â”‚   â”œâ”€â”€ router/
â”‚   â”‚   â””â”€â”€ app_router.dart     # GoRouter ì„¤ì •
â”‚   â”‚
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ date_utils.dart
â”‚       â””â”€â”€ string_utils.dart
â”‚
â”œâ”€â”€ features/
â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â”œâ”€â”€ data/
â”‚   â”‚   â”‚   â””â”€â”€ auth_repository.dart
â”‚   â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”‚   â””â”€â”€ user_model.dart
â”‚   â”‚   â””â”€â”€ presentation/
â”‚   â”‚       â”œâ”€â”€ login_screen.dart
â”‚   â”‚       â”œâ”€â”€ church_code_screen.dart
â”‚   â”‚       â””â”€â”€ onboarding_screen.dart
â”‚   â”‚
â”‚   â”œâ”€â”€ home/
â”‚   â”‚   â”œâ”€â”€ data/
â”‚   â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â””â”€â”€ presentation/
â”‚   â”‚       â””â”€â”€ home_screen.dart
â”‚   â”‚
â”‚   â”œâ”€â”€ sermon/
â”‚   â”‚   â”œâ”€â”€ data/
â”‚   â”‚   â”‚   â””â”€â”€ sermon_repository.dart
â”‚   â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”‚   â”œâ”€â”€ sermon_model.dart
â”‚   â”‚   â”‚   â””â”€â”€ devotion_model.dart
â”‚   â”‚   â””â”€â”€ presentation/
â”‚   â”‚       â”œâ”€â”€ sermon_list_screen.dart
â”‚   â”‚       â””â”€â”€ sermon_detail_screen.dart
â”‚   â”‚
â”‚   â”œâ”€â”€ devotion/
â”‚   â”‚   â”œâ”€â”€ data/
â”‚   â”‚   â”‚   â””â”€â”€ devotion_repository.dart
â”‚   â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”‚   â””â”€â”€ progress_model.dart
â”‚   â”‚   â””â”€â”€ presentation/
â”‚   â”‚       â”œâ”€â”€ daily_devotion_screen.dart
â”‚   â”‚       â””â”€â”€ completion_screen.dart
â”‚   â”‚
â”‚   â”œâ”€â”€ record/
â”‚   â”‚   â””â”€â”€ presentation/
â”‚   â”‚       â””â”€â”€ my_record_screen.dart
â”‚   â”‚
â”‚   â”œâ”€â”€ community/              # Phase 2
â”‚   â”‚   â”œâ”€â”€ testimony/
â”‚   â”‚   â””â”€â”€ prayer/
â”‚   â”‚
â”‚   â””â”€â”€ pastor/
â”‚       â”œâ”€â”€ data/
â”‚       â”‚   â””â”€â”€ pastor_repository.dart
â”‚       â””â”€â”€ presentation/
â”‚           â”œâ”€â”€ pastor_dashboard_screen.dart
â”‚           â””â”€â”€ sermon_upload_screen.dart
â”‚
â””â”€â”€ shared/
    â”œâ”€â”€ widgets/
    â”‚   â”œâ”€â”€ sermon_card.dart
    â”‚   â”œâ”€â”€ encouragement_card.dart
    â”‚   â”œâ”€â”€ progress_indicator.dart
    â”‚   â””â”€â”€ loading_overlay.dart
    â”‚
    â””â”€â”€ providers/
        â”œâ”€â”€ auth_provider.dart
        â””â”€â”€ church_provider.dart
```

### 2.3 ìƒíƒœ ê´€ë¦¬ íŒ¨í„´ (Riverpod)

```dart
// features/sermon/data/sermon_repository.dart
@riverpod
class SermonRepository extends _$SermonRepository {
  @override
  FutureOr<List<Sermon>> build() async {
    final churchId = ref.watch(currentChurchIdProvider);
    return _fetchSermons(churchId);
  }

  Future<List<Sermon>> _fetchSermons(String churchId) async {
    final snapshot = await FirebaseFirestore.instance
        .collection('churches')
        .doc(churchId)
        .collection('sermons')
        .orderBy('date', descending: true)
        .limit(10)
        .get();

    return snapshot.docs
        .map((doc) => Sermon.fromFirestore(doc))
        .toList();
  }
}

// features/devotion/data/devotion_repository.dart
@riverpod
class DevotionProgress extends _$DevotionProgress {
  @override
  Future<Map<String, bool>> build(String sermonId) async {
    final userId = ref.watch(currentUserIdProvider);
    final churchId = ref.watch(currentChurchIdProvider);
    return _fetchProgress(churchId, userId, sermonId);
  }

  Future<void> completeDay(String sermonId, int day) async {
    final userId = ref.read(currentUserIdProvider);
    final churchId = ref.read(currentChurchIdProvider);

    await FirebaseFirestore.instance
        .collection('churches')
        .doc(churchId)
        .collection('members')
        .doc(userId)
        .collection('progress')
        .doc(sermonId)
        .set({'day${day}_complete': true}, SetOptions(merge: true));

    ref.invalidateSelf();
  }
}
```

### 2.4 ë¼ìš°íŒ… (GoRouter)

```dart
// core/router/app_router.dart
@riverpod
GoRouter appRouter(AppRouterRef ref) {
  final authState = ref.watch(authStateProvider);

  return GoRouter(
    initialLocation: '/splash',
    redirect: (context, state) {
      final isLoggedIn = authState.value != null;
      final isOnboarding = state.matchedLocation.startsWith('/onboarding');
      final isAuth = state.matchedLocation.startsWith('/auth');

      if (!isLoggedIn && !isOnboarding && !isAuth) {
        return '/auth/login';
      }
      if (isLoggedIn && isAuth) {
        return '/home';
      }
      return null;
    },
    routes: [
      GoRoute(path: '/splash', builder: (_, __) => const SplashScreen()),
      GoRoute(
        path: '/onboarding',
        builder: (_, __) => const OnboardingScreen(),
      ),
      ShellRoute(
        builder: (context, state, child) => MainShell(child: child),
        routes: [
          GoRoute(path: '/home', builder: (_, __) => const HomeScreen()),
          GoRoute(
            path: '/sermon/:id',
            builder: (_, state) =>
                SermonDetailScreen(id: state.pathParameters['id']!),
          ),
          GoRoute(
            path: '/devotion/:sermonId/:day',
            builder: (_, state) => DailyDevotionScreen(
              sermonId: state.pathParameters['sermonId']!,
              day: int.parse(state.pathParameters['day']!),
            ),
          ),
          GoRoute(path: '/record', builder: (_, __) => const MyRecordScreen()),
          GoRoute(
            path: '/pastor',
            builder: (_, __) => const PastorDashboardScreen(),
          ),
        ],
      ),
    ],
  );
}
```

---

## 3. ë°±ì—”ë“œ (Firebase)

### 3.1 Firestore ë°ì´í„° ëª¨ë¸

```typescript
// Firestore ìŠ¤í‚¤ë§ˆ (TypeScript íƒ€ì… ì •ì˜)

interface Church {
  id: string;
  name: string;
  pastor: string;
  denomination: 'baptist' | 'presbyterian' | 'methodist' | 'holiness' | 'other';
  plan: 'chimshin' | 'wordbridge';
  memberCount: number;
  churchCode: string;         // 4ìë¦¬ ì½”ë“œ
  logoUrl?: string;
  primaryColor?: string;      // í™”ì´íŠ¸ë¼ë²¨ìš©
  settings: ChurchSettings;
  createdAt: Timestamp;
  subscriptionStatus: 'trial' | 'active' | 'expired';
  subscriptionEndDate: Timestamp;
}

interface ChurchSettings {
  autoApproveMembers: boolean;
  notificationSchedule: NotificationSchedule;
  testimonyCuration: 'auto' | 'manual'; // ê°„ì¦ ìë™/ìˆ˜ë™ ê²Œì‹œ
}

interface NotificationSchedule {
  morning: string;   // "09:00"
  lunch: boolean;
  evening: string;   // "20:00"
}

interface Sermon {
  id: string;
  churchId: string;
  title: string;
  date: Timestamp;
  pastor: string;
  bibleBook: string;         // "ìš”í•œë³µìŒ"
  bibleChapter: number;      // 3
  bibleVerseStart: number;   // 16
  bibleVerseEnd?: number;    // 17
  audioUrl?: string;
  youtubeUrl?: string;
  transcriptText?: string;   // STT ê²°ê³¼ ë˜ëŠ” ì›ê³ 
  summary: string;           // AI ìƒì„± ìš”ì•½ (300ì)
  keyTakeaways: string[];    // í•µì‹¬ í¬ì¸íŠ¸ 3ê°œ
  devotional: DailyDevotion[];  // 5ì¼ì¹˜
  aiProcessingStatus: 'pending' | 'processing' | 'complete' | 'failed';
  aiProcessingCompletedAt?: Timestamp;
  createdAt: Timestamp;
  publishedAt?: Timestamp;
}

interface DailyDevotion {
  day: number;               // 1-5
  theme: string;             // "ê¹¨ë‹¬ìŒì˜ ë‚ "
  bibleVerse: string;        // êµ¬ì ˆ
  bibleText: string;         // ë³¸ë¬¸
  meditation: string;        // ë¬µìƒ ê°€ì´ë“œ
  question: string;          // ë¬µìƒ ì§ˆë¬¸
  application: string;       // ì ìš© ë°©ë²•
}

interface Member {
  id: string;
  churchId: string;
  uid: string;               // Firebase Auth UID
  name: string;
  phone?: string;
  email?: string;
  ageGroup: '20s' | '30s' | '40s' | '50s' | '60s+';
  role: 'member' | 'deacon' | 'elder' | 'pastor' | 'admin';
  notificationSettings: NotificationSchedule;
  joinedAt: Timestamp;
  lastActiveAt: Timestamp;
  isActive: boolean;
}

interface MemberProgress {
  memberId: string;
  sermonId: string;
  day1Complete: boolean;
  day2Complete: boolean;
  day3Complete: boolean;
  day4Complete: boolean;
  day5Complete: boolean;
  day1Note?: string;
  day2Note?: string;
  day3Note?: string;
  day4Note?: string;
  day5Note?: string;
  day1CompletedAt?: Timestamp;
  day5CompletedAt?: Timestamp;
}

interface Testimony {
  id: string;
  memberId: string;
  memberName: string;         // ë¹„ì •ê·œí™”
  churchId: string;
  sermonId?: string;
  title?: string;
  content: string;
  visibility: 'church' | 'public' | 'pastor_only';
  status: 'pending' | 'approved' | 'rejected';
  likeCount: number;
  commentCount: number;
  createdAt: Timestamp;
  approvedAt?: Timestamp;
}

interface Prayer {
  id: string;
  memberId: string;
  memberName: string;
  churchId: string;
  content: string;
  type: 'urgent' | 'ongoing';
  prayerCount: number;
  isAnswered: boolean;
  visibility: 'personal' | 'group' | 'church';
  expiresAt?: Timestamp;
  createdAt: Timestamp;
}
```

### 3.2 Firestore Security Rules

```javascript
// firestore.rules
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ê³µí†µ í•¨ìˆ˜
    function isAuthenticated() {
      return request.auth != null;
    }

    function isChurchMember(churchId) {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/churches/$(churchId)/members/$(request.auth.uid));
    }

    function isPastor(churchId) {
      return isAuthenticated() &&
        get(/databases/$(database)/documents/churches/$(churchId)/members/$(request.auth.uid)).data.role == 'pastor';
    }

    function isAdmin(churchId) {
      return isAuthenticated() &&
        get(/databases/$(database)/documents/churches/$(churchId)/members/$(request.auth.uid)).data.role in ['pastor', 'admin'];
    }

    // êµíšŒ ì •ë³´: êµì¸ë§Œ ì½ê¸°, ê´€ë¦¬ìë§Œ ì“°ê¸°
    match /churches/{churchId} {
      allow read: if isChurchMember(churchId);
      allow write: if isAdmin(churchId);

      // ì„¤êµ: êµì¸ ì½ê¸°, ê´€ë¦¬ì ì“°ê¸°
      match /sermons/{sermonId} {
        allow read: if isChurchMember(churchId);
        allow write: if isAdmin(churchId);
      }

      // êµì¸: ë³¸ì¸ë§Œ ì½ê¸°/ì“°ê¸°, ëª©ì‚¬ëŠ” ì „ì²´ ì½ê¸°
      match /members/{memberId} {
        allow read: if request.auth.uid == memberId || isPastor(churchId);
        allow write: if request.auth.uid == memberId || isAdmin(churchId);

        // ê°œì¸ ì§„í–‰ í˜„í™©: ë³¸ì¸ë§Œ ì½ê¸°/ì“°ê¸°
        match /progress/{sermonId} {
          allow read, write: if request.auth.uid == memberId;
          // ëª©ì‚¬ëŠ” ì§‘ê³„ í†µê³„ë§Œ (ê°œë³„ ë¬µìƒ ë©”ëª¨ ì ‘ê·¼ ë¶ˆê°€)
        }
      }

      // ê°„ì¦: êµì¸ ì½ê¸°, ë³¸ì¸ ì“°ê¸°, ëª©ì‚¬ ìŠ¹ì¸
      match /testimonies/{testimonyId} {
        allow read: if isChurchMember(churchId) &&
          (resource.data.status == 'approved' ||
           resource.data.memberId == request.auth.uid ||
           isPastor(churchId));
        allow create: if isChurchMember(churchId);
        allow update: if resource.data.memberId == request.auth.uid ||
          isPastor(churchId);
        allow delete: if resource.data.memberId == request.auth.uid ||
          isAdmin(churchId);
      }

      // ê¸°ë„ ì œëª©
      match /prayers/{prayerId} {
        allow read: if isChurchMember(churchId) &&
          (resource.data.visibility != 'personal' ||
           resource.data.memberId == request.auth.uid);
        allow create, update, delete: if isChurchMember(churchId) &&
          resource.data.memberId == request.auth.uid;
      }
    }
  }
}
```

### 3.3 Cloud Functions

```typescript
// functions/src/index.ts

import * as functions from 'firebase-functions';
import * as admin from 'firebase-admin';
import { processSermonWithAI } from './ai/sermon-processor';
import { sendPushNotification } from './notifications/push';
import { generateEncouragement } from './ai/encouragement';

admin.initializeApp();

// ì„¤êµ ì—…ë¡œë“œ ì‹œ AI ì²˜ë¦¬ íŠ¸ë¦¬ê±°
export const onSermonCreated = functions
  .region('asia-northeast3') // ì„œìš¸
  .firestore
  .document('churches/{churchId}/sermons/{sermonId}')
  .onCreate(async (snap, context) => {
    const sermon = snap.data();
    const { churchId, sermonId } = context.params;

    // AI ì²˜ë¦¬ ì‹œì‘
    await snap.ref.update({ aiProcessingStatus: 'processing' });

    try {
      const processedContent = await processSermonWithAI({
        audioUrl: sermon.audioUrl,
        youtubeUrl: sermon.youtubeUrl,
        transcriptText: sermon.transcriptText,
        title: sermon.title,
        bibleReference: `${sermon.bibleBook} ${sermon.bibleChapter}:${sermon.bibleVerseStart}`,
      });

      await snap.ref.update({
        summary: processedContent.summary,
        keyTakeaways: processedContent.keyTakeaways,
        devotional: processedContent.devotional,
        transcriptText: processedContent.transcript,
        aiProcessingStatus: 'complete',
        aiProcessingCompletedAt: admin.firestore.FieldValue.serverTimestamp(),
      });

      // ëª©ì‚¬ì—ê²Œ ì²˜ë¦¬ ì™„ë£Œ ì•Œë¦¼
      await sendProcessingCompleteNotification(churchId, sermon.title);

    } catch (error) {
      await snap.ref.update({ aiProcessingStatus: 'failed' });
      console.error('AI processing failed:', error);
    }
  });

// ì¼ì¼ ë¬µìƒ ì™„ë£Œ ì‹œ ê²©ë ¤ ë©”ì‹œì§€ ìƒì„±
export const onDevotionComplete = functions
  .region('asia-northeast3')
  .firestore
  .document('churches/{churchId}/members/{memberId}/progress/{sermonId}')
  .onUpdate(async (change, context) => {
    const before = change.before.data();
    const after = change.after.data();
    const { churchId, memberId } = context.params;

    // ìƒˆë¡œ ì™„ë£Œëœ ë‚  ê°ì§€
    for (let day = 1; day <= 5; day++) {
      if (!before[`day${day}Complete`] && after[`day${day}Complete`]) {
        const streak = await calculateStreak(churchId, memberId);
        const message = generateEncouragement({
          day,
          streak,
          isFirstTime: streak === 1,
        });

        // ì¸ì•± ì•Œë¦¼ ì „ì†¡
        await sendInAppNotification(churchId, memberId, message);
        break;
      }
    }
  });

// ë§¤ì¼ ì•„ì¹¨ 9ì‹œ í‘¸ì‹œ ì•Œë¦¼ (KST)
export const dailyMorningNotification = functions
  .region('asia-northeast3')
  .pubsub
  .schedule('0 0 * * *')  // UTC 00:00 = KST 09:00
  .timeZone('Asia/Seoul')
  .onRun(async () => {
    const churches = await admin.firestore()
      .collection('churches')
      .where('subscriptionStatus', '==', 'active')
      .get();

    for (const church of churches.docs) {
      await sendDailyNotificationToChurch(church.id);
    }
  });

// ëª©ì‚¬ ì£¼ê°„ ë¦¬í¬íŠ¸ (ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 9ì‹œ)
export const weeklyPastorReport = functions
  .region('asia-northeast3')
  .pubsub
  .schedule('0 0 * * 1')  // ë§¤ì£¼ ì›”ìš”ì¼ UTC 00:00
  .timeZone('Asia/Seoul')
  .onRun(async () => {
    const churches = await admin.firestore()
      .collection('churches')
      .where('subscriptionStatus', '==', 'active')
      .get();

    for (const church of churches.docs) {
      const report = await generateWeeklyReport(church.id);
      await sendReportToPastor(church.id, report);
    }
  });
```

### 3.4 AI ì²˜ë¦¬ ëª¨ë“ˆ

```typescript
// functions/src/ai/sermon-processor.ts

import OpenAI from 'openai';
import axios from 'axios';

const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

interface SermonInput {
  audioUrl?: string;
  youtubeUrl?: string;
  transcriptText?: string;
  title: string;
  bibleReference: string;
}

interface ProcessedSermon {
  transcript: string;
  summary: string;
  keyTakeaways: string[];
  devotional: DailyDevotion[];
}

export async function processSermonWithAI(input: SermonInput): Promise<ProcessedSermon> {

  // 1ë‹¨ê³„: í…ìŠ¤íŠ¸ í™•ë³´
  let transcript = input.transcriptText;
  if (!transcript && input.audioUrl) {
    transcript = await transcribeAudio(input.audioUrl);
  }
  if (!transcript && input.youtubeUrl) {
    transcript = await transcribeYoutube(input.youtubeUrl);
  }

  // 2ë‹¨ê³„: GPT-4ë¡œ ì½˜í…ì¸  ìƒì„±
  const content = await generateContent(transcript!, input.title, input.bibleReference);

  return { transcript: transcript!, ...content };
}

async function transcribeAudio(audioUrl: string): Promise<string> {
  // Whisper API ì‚¬ìš©
  const audioResponse = await axios.get(audioUrl, { responseType: 'arraybuffer' });
  const audioBuffer = Buffer.from(audioResponse.data);

  const formData = new FormData();
  formData.append('file', new Blob([audioBuffer]), 'sermon.mp3');
  formData.append('model', 'whisper-1');
  formData.append('language', 'ko');

  const transcription = await openai.audio.transcriptions.create({
    file: new File([audioBuffer], 'sermon.mp3', { type: 'audio/mp3' }),
    model: 'whisper-1',
    language: 'ko',
  });

  return transcription.text;
}

async function generateContent(
  transcript: string,
  title: string,
  bibleRef: string
): Promise<Omit<ProcessedSermon, 'transcript'>> {

  const prompt = `
ë‹¹ì‹ ì€ í•œêµ­ ì¹¨ë¡€êµ ì‹ í•™ìì…ë‹ˆë‹¤. ì•„ë˜ ì„¤êµë¥¼ ë¶„ì„í•˜ì—¬ ì„±ë„ë“¤ì˜ ì¼ì£¼ì¼ ë¬µìƒ ê°€ì´ë“œë¥¼ ë§Œë“¤ì–´ì£¼ì„¸ìš”.

ì„¤êµ ì œëª©: ${title}
ë³¸ë¬¸ ë§ì”€: ${bibleRef}
ì„¤êµ ë‚´ìš©:
${transcript.substring(0, 8000)}

ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ JSON ì‘ë‹µí•˜ì„¸ìš”:
{
  "summary": "ì„¤êµ ìš”ì•½ (300ì ì´ë‚´, í•µì‹¬ ë©”ì‹œì§€ ì¤‘ì‹¬)",
  "keyTakeaways": ["í•µì‹¬ í¬ì¸íŠ¸ 1", "í•µì‹¬ í¬ì¸íŠ¸ 2", "í•µì‹¬ í¬ì¸íŠ¸ 3"],
  "devotional": [
    {
      "day": 1,
      "theme": "ê¹¨ë‹¬ìŒì˜ ë‚ ",
      "bibleVerse": "ì„±ê²½ êµ¬ì ˆ (ì„¤êµ ë³¸ë¬¸ ì¤‘)",
      "bibleText": "êµ¬ì ˆ ì „ë¬¸",
      "meditation": "ë¬µìƒ ê°€ì´ë“œ (100ì)",
      "question": "ë¬µìƒ ì§ˆë¬¸ (ì–´ë¥¸ ì¹œí™”ì , êµ¬ì²´ì )",
      "application": "ì˜¤ëŠ˜ ì ìš©í•  ìˆ˜ ìˆëŠ” êµ¬ì²´ì  ë°©ë²• (50ì)"
    },
    // day 2: ê³„íšì˜ ë‚ 
    // day 3: ì ê²€ì˜ ë‚ 
    // day 4: ì‹¬í™”ì˜ ë‚ 
    // day 5: ì •ë¦¬ì˜ ë‚ 
  ]
}

ì‘ì„± ì›ì¹™:
- 50-70ëŒ€ ì„±ë„ë„ ì´í•´í•˜ê¸° ì‰¬ìš´ ì–¸ì–´ ì‚¬ìš©
- ì§€ë‚˜ì¹˜ê²Œ ì‹ í•™ì ì¸ ìš©ì–´ í”¼í•˜ê¸°
- ë”°ëœ»í•˜ê³  ê²©ë ¤ì ì¸ í†¤
- ì‹¤ìƒí™œì—ì„œ ë°”ë¡œ ì ìš© ê°€ëŠ¥í•œ ë‚´ìš©
- ì¡´ëŒ“ë§ ì‚¬ìš© (~í•˜ì„¸ìš”, ~í•´ë³´ì„¸ìš”)
`;

  const response = await openai.chat.completions.create({
    model: 'gpt-4-turbo-preview',
    messages: [{ role: 'user', content: prompt }],
    response_format: { type: 'json_object' },
    temperature: 0.7,
  });

  return JSON.parse(response.choices[0].message.content!);
}
```

---

## 4. í‘¸ì‹œ ì•Œë¦¼ ì‹œìŠ¤í…œ

### 4.1 FCM ì„¤ì •

```typescript
// functions/src/notifications/push.ts

import * as admin from 'firebase-admin';

interface NotificationPayload {
  title: string;
  body: string;
  data?: Record<string, string>;
  imageUrl?: string;
}

export async function sendPushToMember(
  memberId: string,
  churchId: string,
  payload: NotificationPayload
): Promise<void> {
  const memberDoc = await admin.firestore()
    .collection('churches').doc(churchId)
    .collection('members').doc(memberId)
    .get();

  const member = memberDoc.data();
  if (!member?.fcmTokens?.length) return;

  const messages = member.fcmTokens.map((token: string) => ({
    token,
    notification: {
      title: payload.title,
      body: payload.body,
      imageUrl: payload.imageUrl,
    },
    data: payload.data || {},
    android: {
      priority: 'high' as const,
      notification: {
        channelId: 'devotion_reminder',
        priority: 'high' as const,
        sound: 'default',
      },
    },
    apns: {
      payload: {
        aps: {
          sound: 'default',
          badge: 1,
        },
      },
    },
  }));

  await admin.messaging().sendEach(messages);
}
```

### 4.2 ì•Œë¦¼ ìœ í˜• ë° ë©”ì‹œì§€ í…œí”Œë¦¿

```typescript
// functions/src/notifications/templates.ts

export const NOTIFICATION_TEMPLATES = {
  MORNING: (name: string, sermonTitle: string) => ({
    title: `ğŸŒ… ì˜¤ëŠ˜ì˜ ë§ì”€`,
    body: `${name}ë‹˜, "${sermonTitle}" ë¬µìƒ ì¤€ë¹„ëì–´ìš”`,
    data: { screen: 'home', action: 'open_devotion' },
  }),

  SERMON_READY: (title: string) => ({
    title: `ğŸ“– ì´ë²ˆ ì£¼ ë§ì”€ ë„ì°©!`,
    body: `"${title}" ì„¤êµê°€ ë“±ë¡ëì–´ìš”`,
    data: { screen: 'sermon_list' },
  }),

  STREAK_3: (name: string) => ({
    title: `ğŸ”¥ 3ì¼ ì—°ì†!`,
    body: `${name}ë‹˜, ì •ë§ ì˜í•˜ê³  ê³„ì„¸ìš”!`,
    data: { screen: 'record' },
  }),

  RETURN_AFTER_SKIP: (name: string) => ({
    title: `ğŸ’ ë‹¤ì‹œ ì‹œì‘í•´ìš”`,
    body: `${name}ë‹˜, ê¸°ë‹¤ë¦¬ê³  ìˆì—ˆì–´ìš”`,
    data: { screen: 'home' },
  }),

  PASTOR_REPORT: (churchName: string) => ({
    title: `ğŸ“Š ì£¼ê°„ ë¦¬í¬íŠ¸`,
    body: `${churchName} ì´ë²ˆ ì£¼ ì°¸ì—¬ í˜„í™©ì„ í™•ì¸í•˜ì„¸ìš”`,
    data: { screen: 'pastor_dashboard' },
  }),
};
```

---

## 5. ë³´ì•ˆ ì„¤ê³„

### 5.1 ì¸ì¦ ì•„í‚¤í…ì²˜

```
ì‚¬ìš©ì ì¸ì¦ í”Œë¡œìš°:

ì†Œì…œ ë¡œê·¸ì¸ (ì¹´ì¹´ì˜¤/êµ¬ê¸€)
        â†“
Firebase Auth (JWT í† í° ë°œê¸‰)
        â†“
êµíšŒ ë©¤ë²„ì‹­ í™•ì¸ (Firestore)
        â†“
ì—­í•  ê¸°ë°˜ ì ‘ê·¼ ì œì–´ (RBAC)
        â†“
Firestore Security Rules ì ìš©

í† í° ê´€ë¦¬:
- ID Token: 1ì‹œê°„ ìœ íš¨
- Refresh Token: ìë™ ê°±ì‹ 
- ì•± ì„¸ì…˜: 30ì¼ ìœ ì§€
- ì¥ê¸° ë¯¸ì‚¬ìš© ì‹œ ì¬ë¡œê·¸ì¸ (180ì¼)
```

### 5.2 ë°ì´í„° ë³´í˜¸

```typescript
// ë¯¼ê°í•œ ë°ì´í„° ì²˜ë¦¬ ì›ì¹™

// 1. ê°œì¸ ë¬µìƒ ë©”ëª¨ - ì•”í˜¸í™” ì €ì¥
class EncryptedNoteStorage {
  private readonly KEY_PREFIX = 'member_note_';

  async saveNote(memberId: string, content: string): Promise<void> {
    // AES-256 ì•”í˜¸í™” í›„ ì €ì¥
    const encrypted = await this.encrypt(content, memberId);
    await FirebaseFirestore.instance
      .collection('encrypted_notes')
      .doc(`${memberId}_${Date.now()}`)
      .set({ data: encrypted });
  }

  // ëª©ì‚¬ë„ ê°œë³„ ë©”ëª¨ ì—´ëŒ ë¶ˆê°€ (ì•”í˜¸í™” í‚¤: ì‚¬ìš©ìë³„)
}

// 2. ì§‘ê³„ í†µê³„ë§Œ ëª©ì‚¬ì—ê²Œ ì œê³µ
interface PastorStats {
  totalMembers: number;
  activeThisWeek: number;
  completionRate: number;
  averageStreak: number;
  // âŒ ê°œë³„ ì‚¬ìš©ì ë©”ëª¨ ì—†ìŒ
  // âŒ ê°œì¸ ê¸°ë„ ì œëª© ì—†ìŒ
}
```

### 5.3 êµíšŒ ê°„ ë°ì´í„° ê²©ë¦¬

```javascript
// Firestore êµ¬ì¡°ìƒ êµíšŒ ë‹¨ìœ„ ê²©ë¦¬
// ëª¨ë“  ë°ì´í„°ëŠ” /churches/{churchId}/ í•˜ìœ„

// Cloud Functionì—ì„œ churchId ê²€ì¦
export const getChurchStats = functions.https.onCall(
  async (data, context) => {
    if (!context.auth) throw new Error('Unauthorized');

    const { churchId } = data;

    // ìš”ì²­ìê°€ í•´ë‹¹ êµíšŒ ë©¤ë²„ì¸ì§€ í™•ì¸
    const memberDoc = await admin.firestore()
      .collection('churches').doc(churchId)
      .collection('members').doc(context.auth.uid)
      .get();

    if (!memberDoc.exists) {
      throw new functions.https.HttpsError('permission-denied', 'ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤');
    }

    // í†µê³„ ë°˜í™˜
    return await calculateChurchStats(churchId);
  }
);
```

---

## 6. ì„±ëŠ¥ ìµœì í™”

### 6.1 Flutter ì„±ëŠ¥

```dart
// ë¦¬ìŠ¤íŠ¸ ìµœì í™” - ListView.builder ì‚¬ìš©
ListView.builder(
  itemCount: sermons.length,
  itemExtent: 120,  // ê³ ì • ë†’ì´ë¡œ ì„±ëŠ¥ í–¥ìƒ
  itemBuilder: (context, index) {
    return SermonCard(sermon: sermons[index]);
  },
);

// ì´ë¯¸ì§€ ìºì‹±
CachedNetworkImage(
  imageUrl: sermon.thumbnailUrl ?? '',
  placeholder: (_, __) => const ShimmerBox(),
  errorWidget: (_, __, ___) => const DefaultThumbnail(),
  memCacheWidth: 300,  // ë©”ëª¨ë¦¬ ìµœì í™”
);

// ìƒíƒœ êµ¬ë… ìµœì í™” - selectë¡œ í•„ìš”í•œ ë¶€ë¶„ë§Œ
final completionRate = ref.watch(
  progressProvider(sermonId).select(
    (p) => p.value?.completionRate ?? 0.0,
  ),
);
```

### 6.2 Firestore ì¿¼ë¦¬ ìµœì í™”

```typescript
// ì¸ë±ìŠ¤ ì„¤ì • (firestore.indexes.json)
{
  "indexes": [
    {
      "collectionGroup": "sermons",
      "fields": [
        { "fieldPath": "date", "order": "DESCENDING" },
        { "fieldPath": "publishedAt", "order": "DESCENDING" }
      ]
    },
    {
      "collectionGroup": "testimonies",
      "fields": [
        { "fieldPath": "churchId", "order": "ASCENDING" },
        { "fieldPath": "status", "order": "ASCENDING" },
        { "fieldPath": "createdAt", "order": "DESCENDING" }
      ]
    }
  ]
}

// í˜ì´ì§€ë„¤ì´ì…˜ìœ¼ë¡œ ëŒ€ëŸ‰ ë°ì´í„° ì²˜ë¦¬
async function getPaginatedSermons(
  churchId: string,
  lastDoc?: DocumentSnapshot,
  pageSize = 10
) {
  let query = db.collection('churches').doc(churchId)
    .collection('sermons')
    .orderBy('date', 'desc')
    .limit(pageSize);

  if (lastDoc) {
    query = query.startAfter(lastDoc);
  }

  return query.get();
}
```

---

## 7. í…ŒìŠ¤íŠ¸ ì „ëµ

### 7.1 ë‹¨ìœ„ í…ŒìŠ¤íŠ¸

```dart
// test/features/devotion/devotion_repository_test.dart
void main() {
  group('DevotionRepository', () {
    late MockFirestore mockFirestore;
    late DevotionRepository repository;

    setUp(() {
      mockFirestore = MockFirestore();
      repository = DevotionRepository(firestore: mockFirestore);
    });

    test('completeDay updates Firestore correctly', () async {
      // Arrange
      const churchId = 'church_123';
      const memberId = 'member_456';
      const sermonId = 'sermon_789';
      const day = 3;

      // Act
      await repository.completeDay(
        churchId: churchId,
        memberId: memberId,
        sermonId: sermonId,
        day: day,
      );

      // Assert
      verify(mockFirestore
        .collection('churches')
        .doc(churchId)
        .collection('members')
        .doc(memberId)
        .collection('progress')
        .doc(sermonId)
        .set({'day3_complete': true}, SetOptions(merge: true))
      ).called(1);
    });
  });
}
```

### 7.2 í†µí•© í…ŒìŠ¤íŠ¸

```dart
// integration_test/app_test.dart
void main() {
  group('User Journey: Daily Devotion', () {
    testWidgets('complete daily devotion flow', (tester) async {
      app.main();
      await tester.pumpAndSettle();

      // í™ˆ í™”ë©´ í™•ì¸
      expect(find.text('ì˜¤ëŠ˜ì˜ ë§ì”€'), findsOneWidget);

      // ë¬µìƒ ì‹œì‘
      await tester.tap(find.text('ì˜¤ëŠ˜ ë¬µìƒ ì‹œì‘'));
      await tester.pumpAndSettle();

      // ë¬µìƒ í™”ë©´ í™•ì¸
      expect(find.byType(DailyDevotionScreen), findsOneWidget);

      // ì™„ë£Œ íƒ­
      await tester.tap(find.text('ì˜¤ëŠ˜ ì™„ë£Œ!'));
      await tester.pumpAndSettle();

      // ì™„ë£Œ í™”ë©´ í™•ì¸
      expect(find.byType(CompletionScreen), findsOneWidget);
      expect(find.text('ì™„ë£Œ!'), findsOneWidget);
    });
  });
}
```

---

## 8. ëª¨ë‹ˆí„°ë§ ë° ìš´ì˜

### 8.1 Firebase Analytics ì´ë²¤íŠ¸

```dart
// core/analytics/analytics_service.dart
class AnalyticsService {
  final FirebaseAnalytics _analytics;

  Future<void> logDevotionComplete({
    required String sermonId,
    required int day,
    required bool hasNote,
  }) async {
    await _analytics.logEvent(
      name: 'devotion_complete',
      parameters: {
        'sermon_id': sermonId,
        'day': day,
        'has_note': hasNote,
        'timestamp': DateTime.now().millisecondsSinceEpoch,
      },
    );
  }

  Future<void> logEncouragementShown({
    required String type,
    required int streak,
  }) async {
    await _analytics.logEvent(
      name: 'encouragement_shown',
      parameters: {'type': type, 'streak': streak},
    );
  }
}
```

### 8.2 Crashlytics ì„¤ì •

```dart
// main.dart
void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  await Firebase.initializeApp();

  FlutterError.onError = FirebaseCrashlytics.instance.recordFlutterFatalError;
  PlatformDispatcher.instance.onError = (error, stack) {
    FirebaseCrashlytics.instance.recordError(error, stack, fatal: true);
    return true;
  };

  runApp(
    ProviderScope(
      child: const App(),
    ),
  );
}
```

### 8.3 SLA ë° ëª¨ë‹ˆí„°ë§ ì§€í‘œ

| ì§€í‘œ | ëª©í‘œ | ì•Œë¦¼ ì„ê³„ê°’ |
|------|------|------------|
| ì•± í¬ë˜ì‹œìœ¨ | < 0.5% | > 1% |
| Firestore ì§€ì—° | < 500ms | > 2000ms |
| AI ì²˜ë¦¬ ì‹œê°„ | < 30ë¶„ | > 60ë¶„ |
| FCM ì „ë‹¬ë¥  | > 95% | < 90% |
| ì›”ê°„ ê°€ìš©ì„± | > 99.5% | < 99% |

---

## 9. ë°°í¬ ì „ëµ

### 9.1 CI/CD íŒŒì´í”„ë¼ì¸

```yaml
# .github/workflows/deploy.yml
name: Deploy

on:
  push:
    branches: [main, develop]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.16.0'
      - run: flutter test
      - run: flutter analyze

  deploy-android:
    needs: test
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Build Android
        run: flutter build appbundle --release
      - name: Deploy to Play Store
        uses: r0adkll/upload-google-play@v1

  deploy-ios:
    needs: test
    if: github.ref == 'refs/heads/main'
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v3
      - name: Build iOS
        run: flutter build ipa --release
      - name: Deploy to App Store
        uses: apple-actions/upload-testflight-build@v1
```

### 9.2 í™˜ê²½ ë¶„ë¦¬

```
í™˜ê²½:
- development: ë¡œì»¬ ê°œë°œ + Firebase Emulator
- staging: íŒŒì¼ëŸ¿ êµíšŒ í…ŒìŠ¤íŠ¸ (Firebase Staging Project)
- production: ì‹¤ ì„œë¹„ìŠ¤ (Firebase Production Project)

í™˜ê²½ë³€ìˆ˜ ê´€ë¦¬:
- .env.development
- .env.staging
- .env.production
- GitHub Secretsìœ¼ë¡œ CI/CD ê´€ë¦¬
```
